/*! kosgis-rfs 2015-02-05 */

!function(a){"use strict";a.module("rfs",["ui.router","ui.bootstrap","rfs.directives","rfs.services","rfs.controllers","rfs.filters","ngSanitize"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){c.interceptors.push("jsonpInterceptor"),a.state("config",{url:"/:id?x&y&z",controller:"config",templateUrl:"templates/config.html",resolve:{configuration:["$stateParams","$q","$http",function(a,b,c){var d=b.defer();return c.get("http://geo.kosgis.dk/couchdb/app-d2121ee08caf832b73a160f9ea022ad9/"+a.id+"?include_docs=true").success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise}]}}).state("config.indberetninger",{url:"/indberetninger",controller:"indberetninger",templateUrl:"templates/indberetninger.html"}).state("config.indberetning",{url:"/indberetning/:indberetning",controller:"indberetning",templateUrl:"templates/indberetning.html"})}])}(this.angular),function(a,b,c){"use strict";b.Control.RFS=b.Control.extend({options:{position:"topright"},initialize:function(a){b.Util.setOptions(this,a),c.module("rfs").run(["$rootScope",function(b){b.kfticket=a.kfticket,b.sagsbehandler=a.sagsbehandler,b.hideSidebar=a.hideSidebar}])},onAdd:function(b){c.module("rfs").run(["$rootScope",function(a){a.map=b}]);var d=c.element("<leaflet-legend></leaflet-legend>"),e=c.element("<leaflet-navbar></leaflet-navbar>"),f=c.element('<div ui-view class="sidebar" ng-show="sagsbehandler && !hideSidebar"></div>');return c.element(a.body).prepend(f).prepend(e),c.element(d).ready(function(){c.bootstrap(a,["rfs"])}),d[0]},onRemove:function(){}})}(this.document,this.L,this.angular),function(a){"use strict";a.module("rfs.controllers",[]).controller("config",["$scope","$rootScope","$http","$stateParams","configuration","$window",function(a,b,c,d,e,f){b.configuration=e,b.stateParams=d,b.$emit("configuration"),f.document.title=e.name}]).controller("indberetninger",["$scope","$rootScope","$http","$stateParams",function(a,b){a.showSidebar=function(){b.hideSidebar=!b.hideSidebar},b.$on("overlay",function(c,d){b.configuration.database===d.config.database&&(a.layer=d.data)})}]).controller("indberetning",["$scope","$rootScope","$http","$stateParams",function(a,b,c,d){c.get("http://data.kosgis.dk/couchdb/"+b.configuration.database+"/"+d.indberetning).success(function(b){a.indberetning=b}).error(function(a){b.error=a})}])}(this.angular),function(a,b,c){"use strict";a.module("rfs.directives",[]).directive("leafletSearch",["$http","$rootScope","$q","$timeout","kfticket","$sce",function(c,d){return{restrict:"E",templateUrl:"templates/search.html",scope:{widget:"="},controller:["$scope",function(e){var f=b.featureGroup().addTo(d.map),g="http://dawa.aws.dk/vejnavne/autocomplete?",h=function(){e.search.vejnavn&&e.search.input.slice(0,e.search.vejnavn.length)===e.search.vejnavn?(g="http://dawa.aws.dk/adresser/autocomplete?",e.widget.options&&(g+=e.widget.options+"&"),g+="vejnavn="+e.search.vejnavn+"&q="):(g="http://dawa.aws.dk/vejnavne/autocomplete?",e.widget.options&&(g+=e.widget.options+"&"),g+="q="),c.jsonp(g+e.search.input+"&callback=JSON_CALLBACK").then(function(b){if(e.selected=null,1===b.data.length&&8!==e.search.lastKey&&46!==e.search.lastKey){e.search.isopen=!1;var c=b.data[0];c.vejnavn?(e.search.vejnavn=c.tekst,e.selectAddr({name:c.tekst,type:"vejnavn"})):c.adresse&&e.selectAddr({name:c.tekst,type:"adresse",id:c.adresse.id})}else e.search.result=[],a.forEach(b.data,function(a){a.vejnavn?e.search.result.push({name:a.tekst,type:"vejnavn"}):a.adresse&&e.search.result.push({name:a.tekst,type:"adresse",id:a.adresse.id})}),e.search.isopen=b.data.length>0})};e.search={isopen:!1,input:"",result:[]},e.widget.options&&(g+=e.widget.options+"&"),g+="q=",e.keyup=function(a){var b,c;if(e.search.lastKey=a.keyCode,40===a.keyCode){if(e.search.result.length>0)if(e.selected){for(b=0;b<e.search.result.length;b+=1)if(c=e.search.result[b],c===e.selected){b<e.search.result.length-1&&(e.selected=e.search.result[b+1],e.search.input=e.selected.name);break}}else e.selected=e.search.result[0]}else if(38===a.keyCode){if(e.search.result.length>0&&e.selected)for(b=0;b<e.search.result.length;b+=1)if(c=e.search.result[b],c===e.selected){b>0&&(e.selected=e.search.result[b-1],e.search.input=e.selected.name);break}}else h()},e.keydown=function(a){13===a.keyCode&&(a.preventDefault(),e.selectAddr(e.selected),e.search.lastKey=a.keyCode)},e.selectAddr=function(a){"vejnavn"===a.type?(e.search.input=a.name,e.search.vejnavn=a.name,h()):c.jsonp("http://dawa.aws.dk/adresser/"+a.id+"?callback=JSON_CALLBACK").then(function(c){e.search.input=a.name,e.geo=c,f.clearLayers(),f.addLayer(b.marker([c.data.adgangsadresse.adgangspunkt.koordinater[1],c.data.adgangsadresse.adgangspunkt.koordinater[0]])),d.map.setView([c.data.adgangsadresse.adgangspunkt.koordinater[1],c.data.adgangsadresse.adgangspunkt.koordinater[0]],e.widget.zoom||14)})}}]}}]).directive("leafletNavbar",["$http","$rootScope","$q","$timeout","kfticket","$sce",function(a,b){return{restrict:"E",templateUrl:"templates/navbar.html",controller:["$scope",function(a){a.showSidebar=function(){b.hideSidebar=!b.hideSidebar,a.isCollapsed=!0},a.isCollapsed=!0}]}}]).directive("leafletSidebar",["$http","$rootScope","$q","$timeout","kfticket","$sce",function(a,b){return{restrict:"E",templateUrl:"templates/sidebar.html",controller:["$scope",function(a){a.showSidebar=function(){b.hideSidebar=!b.hideSidebar},b.$on("configuration",function(){c.log(b.configuration)}),b.$on("overlay",function(d,e){b.configuration.database===e.config.database&&(c.log(e),a.layer=e.data)})}]}}]).directive("leafletLegend",["$http","$rootScope","$q","$timeout","kfticket","$sce","tilestream",function(c,d,e,f,g,h,i){return{restrict:"E",templateUrl:"templates/legend.html",controller:["$scope","$rootScope",function(d,j){d.trustAsHtml=function(a){h.trustAsHtml(a)},d.isBaselayersCollapsed=!1,d.isOverlaysCollapsed=!1,d.oneAtATime=!0,j.overlays=[];var k=function(a){d.map.options.crs="25832"===a?new b.Proj.CRS.TMS("EPSG:25832","+proj=utm +zone=32 +ellps=GRS80 +units=m +no_defs",[12e4,59e5,1e6,65e5],{resolutions:[1638.4,819.2,409.6,204.8,102.4,51.2,25.6,12.8,6.4,3.2,1.6,.8,.4,.2,.1,.05,.025,.0125,.00625]}):b.CRS.EPSG3857},l=function(d){var h=e.defer();return f(function(){var e,f,k,l,m={},n={};if(d.options&&(m=JSON.parse(d.options,function(a,b){if(b&&"string"==typeof b&&0===b.indexOf("function")){var c=new Function("return "+b)();return c}return b})),d.attribution&&(m.attribution=d.attribution),"xyz"===d.type&&d.url&&""!==d.url)d.ticket?g.getTicket().then(function(a){m.ticket=a,d.leaflet=b.tileLayer(d.url,m),h.resolve(d)}):(d.leaflet=b.tileLayer(d.url,m),h.resolve(d));else if("wms"===d.type)m=a.extend(m,d.wms),d.ticket?g.getTicket().then(function(a){m.ticket=a,d.leaflet=b.tileLayer.wms(d.url,m),h.resolve(d)}):(d.leaflet=b.tileLayer(d.url,m),h.resolve(d));else if("geojson"===d.type||"database"===d.type||"straks"===d.type||"indberetninger"===d.type||"tracking"===d.type||"opgaver"===d.type){if(d.styles)for(e=0;e<d.styles.length;e+=1)f=d.styles[e],n[f.id]=f;if(d.style&&(m.style=JSON.parse(d.style,function(a,b){if(b&&"string"==typeof b&&-1!==b.indexOf("function")){var c=new Function("theme","return "+b)(n);return c}return b})),d.onEachFeature&&(m.onEachFeature=JSON.parse(d.onEachFeature,function(a,b){if(b&&"string"==typeof b&&-1!==b.indexOf("function")){var c=new Function("return "+b)();return c}return b})),d.pointToLayer&&(m.pointToLayer=JSON.parse(d.pointToLayer,function(a,c){if(c&&"string"==typeof c&&-1!==c.indexOf("function")){var d=new Function("theme","L","return "+c)(n,b);return d}return c})),"database"===d.type)c.get("http://geo.kosgis.dk/couchdb/db-"+d.database+"/_all_docs?include_docs=true").success(function(a){for(d.leaflet=b.geoJson(null,m),e=0;e<a.rows.length;e+=1){var c=a.rows[e].doc;"_design"!==c._id.substring(0,7)&&d.leaflet.addData(c)}h.resolve(d)}).error(function(a){h.reject(a)});else if("opgaver"===d.type){for(d.leaflet=b.geoJson(null,m),e=0;e<j.configuration.widgets.length;e+=1)if(l=j.configuration.widgets[e],"opgaver"===l.id){k=!0;break}k?c.get("http://geo.kosgis.dk/couchdb/db-"+l.database+"/_all_docs?include_docs=true").success(function(a){for(e=0;e<a.rows.length;e+=1){var b=a.rows[e].doc;"_design"!==b._id.substring(0,7)&&d.leaflet.addData(b)}h.resolve(d)}).error(function(a){h.reject(a)}):h.reject()}else if("indberetninger"===d.type)c.get("http://geo.kosgis.dk/couchdb/db-"+j.configuration.database+"/_all_docs?include_docs=true").success(function(a){for(d.leaflet=b.geoJson(null,m),e=0;e<a.rows.length;e+=1){var c=a.rows[e].doc;"_design"!==c._id.substring(0,7)&&d.leaflet.addData(c)}h.resolve(d)}).error(function(a){h.reject(a)});else if("tracking"===d.type){for(d.leaflet=b.geoJson(null,m),e=0;e<j.configuration.widgets.length;e+=1)if(l=j.configuration.widgets[e],"tracking"===l.id){k=!0;break}k?c.get("http://geo.kosgis.dk/couchdb/db-"+l.database+"/_all_docs?include_docs=true").success(function(a){for(e=0;e<a.rows.length;e+=1){var b=a.rows[e].doc;"_design"!==b._id.substring(0,7)&&d.leaflet.addData(b)}h.resolve(d)}).error(function(a){h.reject(a)}):h.reject()}else"geojson"===d.type?(d.leaflet=b.geoJson(d.geojson,m),h.resolve(d)):"straks"===d.type&&c.get("/api/"+j.configuration.database+"/straks").success(function(a){a.hasOwnProperty(d.straks)?(d.leaflet=b.geoJson(a[d.straks].geojson,m),h.resolve(d)):h.reject(a)}).error(function(a){h.reject(a)})}else"mbtiles"===d.type&&d.mbtile&&d.bounds&&("undefined"!=typeof d.minZoom&&(m.minZoom=d.minZoom),"undefined"!=typeof d.maxZoom&&(m.maxZoom=d.maxZoom),d.leaflet=b.tileLayer(i+d.mbtile+"/{z}/{x}/{y}."+d.format,m),h.resolve(d))}),h.promise},m=function(a){a.selected&&(d.map.hasLayer(a.leaflet)&&d.map.removeLayer(a.leaflet),d.map.addLayer(a.leaflet),a.leaflet.setZIndex&&a.leaflet.setZIndex(a.index))},n=function(){var a,b;for(a=0;a<j.overlays.length;a+=1)b=j.overlays[a],d.map.hasLayer(b.leaflet)&&d.map.removeLayer(b.leaflet);j.overlays=[],d.map.hasLayer(d.crosshairLayer)&&d.map.removeLayer(d.crosshairLayer)},o=function(){var a,b;for(a=0;a<j.configuration.map.overlays.length;a+=1)b=j.configuration.map.overlays[a],b.index=a+1,j.overlays.push(b),l(b).then(m);d.map.addLayer(d.crosshairLayer),d.crosshairLayer.setZIndex&&d.crosshairLayer.setZIndex(a+1)};d.overlayChange=function(a){d.map.hasLayer(a.leaflet)&&d.map.removeLayer(a.leaflet),m(a)},d.baselayerChange=function(a){a!==d.baselayer&&l(a).then(function(a){var b=d.map.getBounds(),c=a.epsg!==d.baselayer.epsg;d.map.hasLayer(d.baselayer.leaflet)&&d.map.removeLayer(d.baselayer.leaflet),c&&(n(),k(a.epsg)),d.map.addLayer(a.leaflet),a.leaflet.setZIndex&&a.leaflet.setZIndex(0),d.baselayer=a,c&&(d.map.fitBounds(b),o())})},j.overlays=[],d.map=j.map,d.crosshairLayer=b.layerGroup(),d.layer=b.geoJson(),j.$on("configuration",function(){if(d.baselayer)j.stateParams.x&&j.stateParams.y&&j.stateParams.z&&d.map.setView([j.stateParams.y,j.stateParams.x],j.stateParams.z);else{d.isBaselayersCollapsed="undefined"==typeof j.configuration.isBaselayersCollapsed?!1:j.configuration.isBaselayersCollapsed,d.isOverlaysCollapsed="undefined"==typeof j.configuration.isOverlaysCollapsed?!1:j.configuration.isOverlaysCollapsed;var a,b;for(a=0;a<j.configuration.map.baselayers.length;a+=1)if(b=j.configuration.map.baselayers[a],b.selected){d.baselayer=b,d.selectedBaselayer=a;break}d.baselayer&&(k(d.baselayer.epsg),l(d.baselayer).then(function(a){d.map.addLayer(a.leaflet),a.leaflet.setZIndex&&a.leaflet.setZIndex(0),j.stateParams.x&&j.stateParams.y&&j.stateParams.z?d.map.setView([j.stateParams.y,j.stateParams.x],j.stateParams.z):d.map.fitBounds(a.bounds),o()}))}})}]}}])}(this.angular,this.L,this.console),function(a,b){"use strict";b.module("rfs.filters",[]).filter("objectpath",function(){return function(a,b){for(var c=a.split("/"),d=b,e=1;e<c.length;e++){var f=c[e];d.hasOwnProperty(f)&&(d=d[f])}return d}}).filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}})}(this,this.angular,this.console),function(a,b){"use strict";b.module("rfs.services",[]).factory("kfticket",["$q","$http","$rootScope","$browser",function(b,c,d,e){return{getTicket:function(){var f=b.defer(),g=e.cookies();return g.kfticket?a.setTimeout(function(){f.resolve(g.kfticket)},0):c.get(d.kfticket).success(function(){g=e.cookies(),f.resolve(g.kfticket)}).error(function(){f.reject()}),f.promise}}}]).factory("tilestream",["$location",function(a){return"localhost"===a.$$host?"http://localhost:8888/v2/":"http://{s}."+a.$$host+"/tilestream/v2/"}]).factory("jsonpInterceptor",["$timeout","$window",function(a,c){return{request:function(d){if("JSONP"===d.method){var e=b.callbacks.counter.toString(36);d.callbackName="angular_callbacks_"+e,d.url=d.url.replace("JSON_CALLBACK",d.callbackName),a(function(){c[d.callbackName]=b.callbacks["_"+e]},0,!1)}return d},response:function(a){var b=a.config;return"JSONP"===b.method&&delete c[b.callbackName],a},responseError:function(a){var b=a.config;return"JSONP"===b.method&&delete c[b.callbackName],a}}}])}(this,this.angular,this.URL),angular.module("rfs").run(["$templateCache",function(a){"use strict";a.put("templates/config.html","<div class=sidebar-wrapper><div ui-view></div></div>"),a.put("templates/indberetning.html",""),a.put("templates/indberetninger.html",'<div class="panel panel-default"><div class=panel-heading><button type=button class="btn btn-xs btn-default pull-right" ng-click=showSidebar()><i class="fa fa-chevron-left"></i></button><h3 class=panel-title>Indberetninger</h3></div><div class=panel-body><p><div class=row><div class="col-xs-8 col-md-8"><input class="form-control search" placeholder="Filter"></div><div class="col-xs-4 col-md-4"><button type=button class="btn btn-primary pull-right sort" data-sort=feature-name id=sort-btn><i class="fa fa-sort"></i>&nbsp;&nbsp;Sort</button></div></div></p></div><div class="list-group sidebar-table"><a ui-sref=map.indberetning({indberetning:value.feature._id}) class=list-group-item ng-repeat="(key,value) in layer._layers"><div ng-repeat="field in configuration.list">{{field|objectpath:value.feature}}</div></a></div></div>'),a.put("templates/legend.html",'<div ng-class="{\'panel panel-default\':isLayersOpen, \'leaflet-control-layers leaflet-control\':!isLayersOpen}"><div ng-class="{\'panel-heading\':isLayersOpen, \'legend-collapse\':!isLayersOpen}"><h3 class=panel-title><a ng-click="isLayersOpen=!isLayersOpen"><i class="fa fa-globe" ng-class="{\'legend-collapse\':!isLayersOpen}"></i> <span ng-show=isLayersOpen>Lagkontrol</span></a></h3></div><div class=list-group collapse=!isLayersOpen><div class=list-group-item><div class=form-group><h4 class=panel-title><i class=fa ng-class="{\'fa-chevron-circle-up\': !isBaselayersCollapsed, \'fa-chevron-circle-down\': isBaselayersCollapsed}" ng-click="isBaselayersCollapsed=!isBaselayersCollapsed"></i> Baggrundskort</h4></div><div collapse=isBaselayersCollapsed><div class=radio ng-repeat="baselayer in configuration.map.baselayers" ng-init="baselayer.expand=true"><div class="pull-right fa fa-question-circle legend-theme-expand" ng-class="{\'fa-rotate-90\': !baselayer.expand}" ng-click="baselayer.expand=!baselayer.expand"></div><label><input type=radio name=baselayer value={{$index}} ng-model=selectedBaselayer ng-click=baselayerChange(baselayer)>{{baselayer.name}}</label><div collapse=baselayer.expand class="alert alert-info"><i class="fa fa-question-circle"></i> <span ng-bind-html=baselayer.description></span></div></div></div></div><div class=list-group-item><div class=form-group><h4 class=panel-title><i class=fa ng-class="{\'fa-chevron-circle-up\': !isOverlaysCollapsed, \'fa-chevron-circle-down\': isOverlaysCollapsed}" ng-click="isOverlaysCollapsed=!isOverlaysCollapsed"></i> Lag</h4></div><div collapse=isOverlaysCollapsed><div class=form-group ng-repeat="overlay in overlays" ng-init="overlay.expand=true"><div class=checkbox><div class="pull-right fa fa-question-circle legend-theme-expand" ng-class="{\'fa-rotate-90\': !overlay.expand}" ng-click="overlay.expand=!overlay.expand"></div><label><input type=checkbox ng-model=overlay.selected ng-change=overlayChange(overlay)>{{overlay.name}}</label></div><div collapse=overlay.expand><table><tr ng-repeat="value in overlay.styles" ng-init="x=(value.style.radius && value.style.weight)?(value.style.radius + value.style.weight):12"><td style=text-align:center;padding-right:5px><svg ng-style="{\'line-height\':(value.style.radius && value.style.weight)?(value.style.radius + value.style.weight)*2+\'px\':\'24px\',\'height\':(value.style.radius && value.style.weight)?(value.style.radius + value.style.weight)*2+\'px\':\'24px\',\'width\':(value.style.radius && value.style.weight)?(value.style.radius + value.style.weight)*2+\'px\':\'24px\' }"><circle ng-attr-cx={{x}} ng-attr-cy={{x}} ng-attr-r={{value.style.radius||10}} ng-attr-fill="{{value.style.fillColor||value.style.color||\'#03f\'}}" ng-attr-fill-opacity={{value.style.fillOpacity||0.5}} ng-attr-stroke-opacity={{value.style.opacity||0.5}} ng-attr-stroke="{{value.style.color||\'#03f\'}}" ng-attr-stroke-width="{{value.style.weight||2}}"></svg></td><td>{{value.id}}</td></tr></table><div class="alert alert-info"><i class="fa fa-question-circle"></i> <span ng-bind-html=overlay.description></span></div></div></div></div></div></div></div>'),a.put("templates/navbar.html",'<div class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle ng-click="isCollapsed = !isCollapsed"><span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><div class=navbar-brand>{{configuration.name}}</div></div><div class=navbar-collapse collapse=isCollapsed><ul class="nav navbar-nav" ng-if=sagsbehandler><li ng-class={active:!hideSidebar}><a ng-click=showSidebar()>Indberetninger</a></li></ul><div ng-repeat="widget in configuration.widgets"><leaflet-search widget=widget ng-if="widget.id===\'adressesøgning\'"></leaflet-search></div></div></div></div>'),a.put("templates/search.html",'<ul class="nav navbar-nav navbar-right"><li class=dropdown dropdown is-open=search.isopen><form class="navbar-form navbar-right" role=search><div class="form-group has-feedback"><input id=searchbox placeholder={{widget.name}} class=form-control ng-model=search.input ng-keyup=keyup($event) ng-keydown=keydown($event)> <span class="glyphicon glyphicon-search form-control-feedback"></span></div></form><ul id=searchlist class=dropdown-menu role=menu><li ng-repeat="s in search.result" ng-class="{active: s==selected}"><a href=# ng-click=selectAddr(s)>{{s.name}}</a></li></ul></li></ul>')}]);
//# sourceMappingURL=kosgis-rfs.min.js.map